# Table of Contents

* [1 外存组织方式](#1-外存组织方式)
  * [1.1 连续组织方式](#11-连续组织方式)
  * [1.2 链接组织方式](#12-链接组织方式)
    * [1.2.1 隐式链接方式](#121-隐式链接方式)
    * [1.2.2 显式链接方式](#122-显式链接方式)
  * [1.3 索引组织方式](#13-索引组织方式)
  * [1.4 混合索引方式](#14-混合索引方式)
  * [1.5 `NTFS`的组织方式](#15-ntfs的组织方式)
* [2 文件存储空间的管理](#2-文件存储空间的管理)
  * [2.1 空闲表法](#21-空闲表法)
  * [2.2 空闲链表法](#22-空闲链表法)
  * [2.3 位示图法](#23-位示图法)
  * [2.4 成组链接法](#24-成组链接法)
* [3 提高磁盘`I/O`方法](#3-提高磁盘io方法)
  * [3.1 磁盘高速缓存](#31-磁盘高速缓存)
  * [3.2 提前读](#32-提前读)
  * [3.3 延迟写](#33-延迟写)
  * [3.4 优化物理布局](#34-优化物理布局)
  * [3.5 虚拟盘](#35-虚拟盘)
  * [3.6 廉价磁盘冗余阵列（`RAID`）](#36-廉价磁盘冗余阵列raid)
* [4 磁盘可靠性技术](#4-磁盘可靠性技术)
  * [4.1 第一级容错技术（`SFT-I`）](#41-第一级容错技术sft-i)
  * [4.2 第二级容错技术（`SFT-II`）](#42-第二级容错技术sft-ii)
  * [4.3 第三级容错技术（`SFT-III`）](#43-第三级容错技术sft-iii)


﻿
# 1 外存组织方式
5种：

- 连续组织方式
- 链接组织方式
- 索引组织方式
- 混合索引方式
- `NTFS`特有方式

## 1.1 连续组织方式
又叫连续分配方式，是指为每个文件分配一组相邻的物理块，并将文件中的信息按逻辑顺序依次存放在这些物理块中，文件首个物理块的地址被登记在`FCB`中 ，这样所形成的文件物理结构被称为顺序结构，相应的物理文件被称为顺序文件。

优点是管理简单，存取速度快，支持随机存取，但缺点是会造成碎片，严重降低存储空间的利用率，而且在分配前需要事先知道文件的长度，使得文件内容的增删以及文件的动态增长都不方便。

## 1.2 链接组织方式
链接组织方式采取离散分配方式，可以分为隐式链接和显式链接两种。

### 1.2.1 隐式链接方式
将一个文件离散地存放在外存上，首个物理块地址被登录在`FCB`的物理地址字段中，后续物理块地址则登记在分配给它的前一个物理块中，从而使得存放同一个文件的所有物理块信息的逻辑顺序形成一个链。

优点是解决了外部碎片问题以及存放文件前必须预知文件长度的问题，但是只支持顺序访问，不支持随机访问，而且可靠性较差，因为任何一个指针出现问题就会导致整个链断开。

### 1.2.2 显式链接方式
将各个物理块指针显式登记在一张文件分配表`FAT`中，`FAT`的每个表项对应与文件存储空间的一个物理块，表项的内容及时分配给文件的下一个物理块的指针。

优点是相比起隐式链接，提高了可靠性，有一定的随机存取功能，但不支持高效的随机存取，而且对于容量较大的存储介质，难以把整个`FAT`装入内存。

## 1.3 索引组织方式
为每个文件建立一个索引块或索引表，用来登记分配给该文件的所有物理块号，文件`FCB`物理地址字段中填上指向该索引表的指针，若文件较大，可以采取多级索引方式。

优点是支持高效的随机存取，但是对于索引表本身来说需要花费较多的外存空间，会造成外存空间的浪费。

## 1.4 混合索引方式
`UNIX`中将多种索引方式结合起来，叫做混合索引方式，或增量索引方式。文件的索引结点中有13个地址项，可以分为三类：

- 直接地址：`i_addr[0]-i_addr[9]`共10个地址项，称为直接地址，当文件长度不超过每个物理块*10的长度时，可直接从`i结点`找到每个物理块的地址
- 一次间址：`i_addr[10]`称为一次间址，存放的是分配给文件的一次间址的地址，假设每个物理块需要`4个字节`来描述，则`4KB`的一个物理块（一个间址块）可以存放`4KB/4=1K`个物理块号，也就是可以存储长达`40KB+1K*4KB`的文件
- 多次间址：`i_addr[11]`称为二次间址，登记的是分配给文件的二次间址块的地址，同样道理可以存放`40KB+4MB+4GB`的文件，而`i_addr[12]`作为三次间址，可以存放`40KB+4MB+4GB+4TB`的文件。

优点是既能节省存储地址所占的存储空间，又具有较快的查找速度。

## 1.5 `NTFS`的组织方式
`NTFS`中以卷为单位，将一个卷中的所有文件信息、目录信息以及可用的未分配空间信息记录在一张主控文件表`MFT`中，卷中的每个文件作为一条记录，每行大小固定`1KB`，每行称为元数据，或称为文件控制字。

在`MFT`中，每个元数据都能将其对应文件的所有信息，组织在所对应文件的一组属性中，文件的内容用其中的`DATA`属性描述，文件较小时可将文件内容直接记录在元数据的`DATA`属性中，这样就减少了磁盘访问次数，文件较大时将文件内容记录到卷中的其他可用区域中，并将这些区域的簇数和起始簇号保存在元数据的`DATA`中，从而可以方便地查到这些簇。

# 2 文件存储空间的管理
主要有三种：

- 空闲表法
- 空闲链表法
- 位示图法
- 成组链接法

## 2.1 空闲表法
系统利用一张空闲表来管理空闲的文件存储空间，其中每个表项对应于一个空闲区，并登记该空闲区的起始块号和块数等信息，具有较高的分配速度。
## 2.2 空闲链表法
可以分为空闲盘块链以及空闲盘区链，空闲盘块链只适合离散分配，空闲盘区链既适合离散分配也适合连续分配。
## 2.3 位示图法
利用二进制的一位来表示文件存储空间中的一个块的使用情况，既适合离散分配也适合连续分配。
## 2.4 成组链接法
`UNIX`采用的管理方式，将一个文件卷的所有空闲盘块按固定大小分成若干组，并将每一个组的盘块数和该组的盘块号记入前一组的最后一个盘块中，第一组的盘块数和该组的所有盘块号则记入超级块的空闲盘块号栈中。

# 3 提高磁盘`I/O`方法
## 3.1 磁盘高速缓存
在内存中设置一个缓冲区，存放磁盘块中某些盘块的副本，读取时直接从内存中读取。

## 3.2 提前读
读取当前盘块时，将下一个可能要访问的盘块中的数据页读入缓冲区。

## 3.3 延迟写
写数据时置上延迟写标记并挂到空闲缓冲队列的末尾，当缓冲区移到空闲缓冲队列的首部，才将缓冲区中的数据写入磁盘。
## 3.4 优化物理布局
优化文件物理块的分布，使访问文件时磁头的移动距离尽可能短。
## 3.5 虚拟盘
又叫`RAM`盘，利用内存空间去仿真磁盘。
## 3.6 廉价磁盘冗余阵列（`RAID`）
利用一台磁盘阵列控制器，来统一管理和控制一组磁盘驱动器，组成一个高度可靠的、快速的大容量磁盘系统。

# 4 磁盘可靠性技术
## 4.1 第一级容错技术（`SFT-I`）
又叫低级磁盘容错技术，防止因磁盘表面发生的缺陷而引起的数据丢失，常用措施有：

- 双份目录和双份文件分配表：在不同磁盘或在磁盘的不同区域中分别建立两份目录表和文件分配表`FAT`
- 热修复重定向：将磁盘容量的一部分保留下来，作为热修复重定向区，磁盘某个块损坏时，将待写数据写入到热修复重定向的一个块中
- 写后读校验：每次从内存缓冲区向磁盘写入一个数据块后，立即读入内存中的另一个缓冲区，并将两个缓冲区的内容进行比较

## 4.2 第二级容错技术（`SFT-II`）
又叫中级磁盘容错技术，防止因磁盘驱动器和磁盘控制器的故障所导致的数据损坏，措施：

- 磁盘镜像：在同一台磁盘控制器下再增设一个完全相同的磁盘驱动器，向主磁盘写数据后，采用写后校验方式，并同样写到备份磁盘上
- 磁盘双工：每次同时将数据写到两个处于不同控制器下的磁盘上

## 4.3 第三级容错技术（`SFT-III`）
又叫高级系统容错技术，利用集群实现，主要方式有：

- 双机热备份：一台主服务器+一台备份服务器，主服务器出现故障后立刻使用备份服务器，主服务器故障修复后成为新的备份服务器
- 双机互为备份：两台均为在线服务器，各自完成自己的任务，同时还接收来自另一台服务器发来的备份数据
- 公用磁盘模式：将多台计算机连接到一台公共磁盘系统上


